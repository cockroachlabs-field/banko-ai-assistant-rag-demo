# Docker Compose for Banko AI with Agentic AI System
# This extends the base docker-compose.yml with agent services

version: '3.8'

services:
  # CockroachDB database (same as base)
  cockroachdb:
    image: cockroachdb/cockroach:v25.4.0
    container_name: banko-cockroachdb
    hostname: cockroachdb
    ports:
      - "26257:26257"  # SQL port
      - "8080:8080"    # Admin UI
    command: start-single-node --insecure
    volumes:
      - cockroach-data:/cockroach/cockroach-data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health?ready=1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - banko-network

  # CockroachDB initialization - enable vector index
  cockroach-init:
    image: cockroachdb/cockroach:v25.4.0
    container_name: banko-cockroach-init
    depends_on:
      cockroachdb:
        condition: service_healthy
    command: >
      sql --insecure --host=cockroachdb:26257
      --execute="SET CLUSTER SETTING feature.vector_index.enabled = true;"
    networks:
      - banko-network
    restart: "no"

  # Banko AI Assistant with Agent Dashboard
  banko-ai:
    build:
      context: .
      dockerfile: Dockerfile
    image: virag/banko-ai-assistant:latest
    container_name: banko-ai-assistant
    ports:
      - "5001:5001"  # Changed to 5001 for agents
    depends_on:
      cockroachdb:
        condition: service_healthy
      cockroach-init:
        condition: service_completed_successfully
    environment:
      # Database configuration
      - DATABASE_URL=cockroachdb://root@cockroachdb:26257/defaultdb?sslmode=disable
      
      # AI Service
      - AI_SERVICE=${AI_SERVICE:-openai}
      
      # OpenAI configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      
      # AWS Bedrock configuration
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_MODEL_ID=${AWS_MODEL_ID:-us.anthropic.claude-3-5-sonnet-20241022-v2:0}
      
      # Google Gemini configuration
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_MODEL=${GOOGLE_MODEL:-gemini-2.0-flash-001}
      
      # IBM Watsonx configuration
      - WATSONX_API_KEY=${WATSONX_API_KEY}
      - WATSONX_PROJECT_ID=${WATSONX_PROJECT_ID}
      - WATSONX_MODEL_ID=${WATSONX_MODEL_ID:-meta-llama/llama-2-70b-chat}
      
      # Agent configuration
      - TOKENIZERS_PARALLELISM=false
      
      # Flask configuration
      - FLASK_ENV=${FLASK_ENV:-production}
      - SECRET_KEY=${SECRET_KEY:-changeme-generate-random-key}
      - PORT=5001
      
      # Cache configuration
      - CACHE_SIMILARITY_THRESHOLD=${CACHE_SIMILARITY_THRESHOLD:-0.75}
      - CACHE_TTL_HOURS=${CACHE_TTL_HOURS:-24}
      
      # Database pool configuration
      - DB_POOL_SIZE=${DB_POOL_SIZE:-100}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-100}
      
      # Embedding model
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - banko-network
    restart: unless-stopped

  # Fraud Agent (us-west-2)
  fraud-agent:
    build:
      context: .
      dockerfile: Dockerfile
    image: virag/banko-ai-assistant:latest
    container_name: banko-fraud-agent
    depends_on:
      cockroachdb:
        condition: service_healthy
      cockroach-init:
        condition: service_completed_successfully
    environment:
      - DATABASE_URL=cockroachdb://root@cockroachdb:26257/defaultdb?sslmode=disable
      - AI_SERVICE=${AI_SERVICE:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_MODEL_ID=${AWS_MODEL_ID}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - TOKENIZERS_PARALLELISM=false
      - AGENT_TYPE=fraud
      - AGENT_REGION=us-west-2
      - FRAUD_THRESHOLD=0.7
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
    command: >
      python -c "
      import os, time;
      from langchain_openai import ChatOpenAI;
      from sentence_transformers import SentenceTransformer;
      from banko_ai.agents.fraud_agent import FraudAgent;
      llm = ChatOpenAI(model=os.getenv('OPENAI_MODEL', 'gpt-4o-mini'), api_key=os.getenv('OPENAI_API_KEY'));
      embedding_model = SentenceTransformer(os.getenv('EMBEDDING_MODEL', 'all-MiniLM-L6-v2'));
      agent = FraudAgent(region='us-west-2', llm=llm, database_url=os.getenv('DATABASE_URL'), embedding_model=embedding_model, fraud_threshold=0.7);
      print(f'‚úÖ Fraud Agent started: {agent.agent_id}');
      while True:
        try:
          result = agent.scan_recent_expenses(hours=24, limit=10);
          print(f'üîç Scanned {result.get(\"total_analyzed\", 0)} expenses, found {result.get(\"total_flagged\", 0)} suspicious');
          time.sleep(300);
        except KeyboardInterrupt:
          break;
        except Exception as e:
          print(f'‚ö†Ô∏è  Error: {e}');
          time.sleep(60);
      "
    networks:
      - banko-network
    restart: unless-stopped

  # Budget Agent (us-central-1)
  budget-agent:
    build:
      context: .
      dockerfile: Dockerfile
    image: virag/banko-ai-assistant:latest
    container_name: banko-budget-agent
    depends_on:
      cockroachdb:
        condition: service_healthy
      cockroach-init:
        condition: service_completed_successfully
    environment:
      - DATABASE_URL=cockroachdb://root@cockroachdb:26257/defaultdb?sslmode=disable
      - AI_SERVICE=${AI_SERVICE:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - TOKENIZERS_PARALLELISM=false
      - AGENT_TYPE=budget
      - AGENT_REGION=us-central-1
      - ALERT_THRESHOLD=0.8
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
    command: >
      python -c "
      import os, time;
      from langchain_openai import ChatOpenAI;
      from banko_ai.agents.budget_agent import BudgetAgent;
      llm = ChatOpenAI(model=os.getenv('OPENAI_MODEL', 'gpt-4o-mini'), api_key=os.getenv('OPENAI_API_KEY'));
      agent = BudgetAgent(region='us-central-1', llm=llm, database_url=os.getenv('DATABASE_URL'), alert_threshold=0.8);
      print(f'‚úÖ Budget Agent started: {agent.agent_id}');
      while True:
        try:
          print('üí∞ Budget monitoring active...');
          time.sleep(300);
        except KeyboardInterrupt:
          break;
        except Exception as e:
          print(f'‚ö†Ô∏è  Error: {e}');
          time.sleep(60);
      "
    networks:
      - banko-network
    restart: unless-stopped

  # Receipt Agent (us-east-1)
  receipt-agent:
    build:
      context: .
      dockerfile: Dockerfile
    image: virag/banko-ai-assistant:latest
    container_name: banko-receipt-agent
    depends_on:
      cockroachdb:
        condition: service_healthy
      cockroach-init:
        condition: service_completed_successfully
    environment:
      - DATABASE_URL=cockroachdb://root@cockroachdb:26257/defaultdb?sslmode=disable
      - AI_SERVICE=${AI_SERVICE:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - TOKENIZERS_PARALLELISM=false
      - AGENT_TYPE=receipt
      - AGENT_REGION=us-east-1
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
    command: >
      python -c "
      import os, time;
      from langchain_openai import ChatOpenAI;
      from sentence_transformers import SentenceTransformer;
      from banko_ai.agents.receipt_agent import ReceiptAgent;
      llm = ChatOpenAI(model=os.getenv('OPENAI_MODEL', 'gpt-4o-mini'), api_key=os.getenv('OPENAI_API_KEY'));
      embedding_model = SentenceTransformer(os.getenv('EMBEDDING_MODEL', 'all-MiniLM-L6-v2'));
      agent = ReceiptAgent(region='us-east-1', llm=llm, database_url=os.getenv('DATABASE_URL'), embedding_model=embedding_model);
      print(f'‚úÖ Receipt Agent started: {agent.agent_id}');
      while True:
        try:
          print('üìÑ Receipt processing ready...');
          time.sleep(300);
        except KeyboardInterrupt:
          break;
        except Exception as e:
          print(f'‚ö†Ô∏è  Error: {e}');
          time.sleep(60);
      "
    networks:
      - banko-network
    restart: unless-stopped

volumes:
  cockroach-data:
    driver: local

networks:
  banko-network:
    driver: bridge
